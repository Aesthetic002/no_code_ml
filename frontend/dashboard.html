<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NoCode ML - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 min-h-screen text-gray-100">
    <!-- Navigation Bar -->
    <nav class="bg-slate-800/50 backdrop-blur border-b border-slate-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center gap-3">
                    <i class="fas fa-brain text-2xl bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent"></i>
                    <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-400 to-cyan-400 bg-clip-text text-transparent">NoCode ML</h1>
                </div>
                <div class="flex items-center gap-4">
                    <span class="text-gray-400">Welcome, <span id="username" class="text-blue-300 font-semibold"></span></span>
                    <button id="adminBtn" onclick="goToAdmin()" class="hidden px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg flex items-center gap-2 transition-colors">
                        <i class="fas fa-crown"></i>Admin
                    </button>
                    <button onclick="logout()" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg flex items-center gap-2 transition-colors">
                        <i class="fas fa-sign-out-alt"></i>Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="min-h-screen py-8 px-4 sm:px-6 lg:px-8">
        <div class="max-w-6xl mx-auto">
            <div class="text-center mb-8">
                <p class="text-gray-400 text-lg">Train and deploy ML models</p>
            </div>

            <!-- Mode Buttons -->
            <div class="mb-8 flex justify-center gap-4">
                <button onclick="switchMode('train')" id="modeTrainBtn" class="px-8 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white font-semibold rounded-lg shadow-lg">
                    <i class="fas fa-rocket mr-2"></i>Train
                </button>
                <button onclick="switchMode('predict')" id="modePredictBtn" class="px-8 py-3 bg-slate-700 text-gray-300 font-semibold rounded-lg">
                    <i class="fas fa-crystal-ball mr-2"></i>Predict
                </button>
            </div>

            <!-- Train Mode -->
            <div id="trainMode" class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Upload -->
                <div class="bg-gradient-to-br from-slate-800 to-slate-700 rounded-xl p-6 border border-slate-600">
                    <h2 class="text-xl font-bold text-blue-300 mb-4"><i class="fas fa-upload mr-2"></i>Upload</h2>
                    <input type="file" id="csvFile" accept=".csv" class="hidden" onchange="handleFileSelect()">
                    <label for="csvFile" class="block cursor-pointer">
                        <div class="border-2 border-dashed border-blue-500/30 rounded-lg p-8 text-center hover:border-blue-500/60">
                            <i class="fas fa-cloud-upload-alt text-4xl text-blue-400 mb-2 block"></i>
                            <p class="text-blue-300 font-semibold">Upload CSV</p>
                            <p id="fileName" class="text-green-400 text-sm hidden"></p>
                        </div>
                    </label>
                    <button onclick="analyze()" class="w-full mt-4 bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 rounded-lg">
                        <i class="fas fa-wand-magic-wand mr-2"></i>Analyze
                    </button>
                    <button onclick="aiAnalyze()" class="w-full mt-2 bg-gradient-to-r from-blue-600 to-cyan-500 hover:from-blue-700 hover:to-cyan-600 text-white font-semibold py-2 rounded-lg">
                        <i class="fas fa-brain mr-2"></i>AI Analyze
                    </button>
                    <div id="analysisCard" class="hidden mt-4 bg-slate-900/50 rounded-lg p-4 border border-blue-500/30">
                        <div id="analysis" class="space-y-2 text-sm text-gray-300"></div>
                    </div>
                </div>

                <!-- Train -->
                <div class="bg-gradient-to-br from-slate-800 to-slate-700 rounded-xl p-6 border border-slate-600">
                    <h2 class="text-xl font-bold text-purple-300 mb-4"><i class="fas fa-dumbbell mr-2"></i>Train</h2>
                    <div class="space-y-3">
                        <input type="text" id="modelName" placeholder="Model name" class="w-full bg-slate-700 border border-purple-500/30 rounded px-3 py-2 text-gray-100">
                        <select id="modelType" class="w-full bg-slate-700 border border-purple-500/30 rounded px-3 py-2 text-gray-100">
                            <option value="">Auto</option>
                            <option value="regression">Regression</option>
                            <option value="classification">Classification</option>
                        </select>
                        <button onclick="train()" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 rounded-lg">
                            <i class="fas fa-rocket mr-2"></i>Train
                        </button>
                    </div>
                    <div id="trainLoading" class="hidden mt-4 flex items-center gap-2 text-purple-300">
                        <i class="fas fa-spinner fa-spin"></i><span>Training...</span>
                    </div>
                    <div id="trainResultCard" class="hidden mt-4 bg-slate-900/50 rounded-lg p-4 border border-purple-500/30">
                        <div id="trainResult" class="space-y-2 text-sm text-gray-300"></div>
                    </div>
                </div>

                <!-- Quick Predict -->
                <div class="bg-gradient-to-br from-slate-800 to-slate-700 rounded-xl p-6 border border-slate-600">
                    <h2 class="text-xl font-bold text-emerald-300 mb-4"><i class="fas fa-bolt mr-2"></i>Quick Test</h2>
                    <div id="quickInputsContainer" class="hidden space-y-2 mb-4 bg-slate-900/30 p-3 rounded" style="max-height: 300px; overflow-y: auto;">
                        <div id="quickInputs"></div>
                    </div>
                    <button id="quickPredictBtn" onclick="quickPredict()" disabled class="w-full bg-emerald-500 hover:bg-emerald-600 disabled:bg-gray-600 text-white font-semibold py-2 rounded-lg">
                        <i class="fas fa-zap mr-2"></i>Predict
                    </button>
                    <div id="quickLoading" class="hidden mt-4 flex items-center gap-2 text-emerald-300">
                        <i class="fas fa-spinner fa-spin"></i><span>Predicting...</span>
                    </div>
                    <div id="quickResultCard" class="hidden mt-4 bg-emerald-500/10 rounded-lg p-4 border border-emerald-500/50">
                        <div id="quickResult" class="text-sm text-gray-200 font-mono"></div>
                    </div>
                </div>
            </div>

            <!-- Predict Mode -->
            <div id="predictMode" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Model Selection -->
                <div class="bg-gradient-to-br from-slate-800 to-slate-700 rounded-xl p-6 border border-slate-600">
                    <h2 class="text-xl font-bold text-blue-300 mb-4"><i class="fas fa-folder-open mr-2"></i>Select Model</h2>
                    <div class="space-y-3">
                        <select id="predModelType" onchange="loadPredictModels()" class="w-full bg-slate-700 border border-blue-500/30 rounded px-3 py-2 text-gray-100">
                            <option value="regression">Regression</option>
                            <option value="classification">Classification</option>
                        </select>
                        <select id="predModelList" onchange="loadPredictFeatures()" class="w-full bg-slate-700 border border-blue-500/30 rounded px-3 py-2 text-gray-100">
                            <option>Select model...</option>
                        </select>
                    </div>
                    <div id="modelInfoCard" class="hidden mt-4 bg-slate-900/50 rounded-lg p-3 border border-blue-500/30">
                        <div id="modelInfo" class="space-y-2 text-sm text-gray-300"></div>
                    </div>
                </div>

                <!-- Prediction -->
                <div class="bg-gradient-to-br from-slate-800 to-slate-700 rounded-xl p-6 border border-slate-600">
                    <h2 class="text-xl font-bold text-emerald-300 mb-4"><i class="fas fa-crystal-ball mr-2"></i>Predict</h2>
                    <div id="predInputsContainer" class="hidden space-y-2 mb-4 bg-slate-900/30 p-3 rounded" style="max-height: 300px; overflow-y: auto;">
                        <div id="predInputs"></div>
                    </div>
                    <button id="predPredictBtn" onclick="makePrediction()" disabled class="w-full bg-emerald-500 hover:bg-emerald-600 disabled:bg-gray-600 text-white font-semibold py-2 rounded-lg">
                        <i class="fas fa-wand-magic-wand mr-2"></i>Predict
                    </button>
                    <div id="predLoading" class="hidden mt-4 flex items-center gap-2 text-emerald-300">
                        <i class="fas fa-spinner fa-spin"></i><span>Predicting...</span>
                    </div>
                    <div id="predResultCard" class="hidden mt-4 bg-emerald-500/10 rounded-lg p-4 border border-emerald-500/50">
                        <div id="predResult" class="text-sm text-gray-200 font-mono"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let features = [], uploadedFile = null, token = localStorage.getItem('token');

        window.addEventListener('load', () => {
            if (!token) window.location.href = '/frontend/auth.html';
            loadProfile();
            loadPredictModels();
        });

        async function loadProfile() {
            try {
                const res = await fetch('http://127.0.0.1:9000/api/user/profile', 
                    { headers: { 'Authorization': `Bearer ${token}` } });
                if (!res.ok) throw new Error('Failed to load profile');
                const data = await res.json();
                document.getElementById('username').textContent = data.username;
                if (data.is_admin) document.getElementById('adminBtn').classList.remove('hidden');
            } catch (error) {
                console.error('Error loading profile:', error);
                window.location.href = '/frontend/auth.html';
            }
        }

        function logout() {
            localStorage.clear();
            window.location.href = '/frontend/auth.html';
        }

        function goToAdmin() {
            window.location.href = '/frontend/admin.html';
        }

        function switchMode(mode) {
            document.getElementById('trainMode').classList.toggle('hidden', mode === 'predict');
            document.getElementById('predictMode').classList.toggle('hidden', mode === 'train');
        }

        function handleFileSelect() {
            const file = document.getElementById("csvFile").files[0];
            if (file) {
                uploadedFile = file;
                document.getElementById("fileName").textContent = "‚úì " + file.name;
                document.getElementById("fileName").classList.remove("hidden");
            }
        }

        async function analyze() {
            if (!uploadedFile) { alert("Select CSV first"); return; }
            const fd = new FormData();
            fd.append("file", uploadedFile);
            const res = await fetch("http://127.0.0.1:9000/analyze", 
                { method: "POST", body: fd, headers: { 'Authorization': `Bearer ${token}` } });
            const data = await res.json();
            features = data.feature_columns;
            
            // Build detailed analysis report
            let analysisHTML = `
                <div class="space-y-2">
                    <p><strong>Original Data:</strong> ${data.rows} rows | ${data.columns} columns</p>
                    <p><strong>After Cleaning:</strong> ${data.cleaned_rows} rows (${data.rows_retained_percent}% retained)</p>
                    <p><strong>Target Column:</strong> ${data.target_column}</p>
                    <p><strong>Features:</strong> ${data.feature_columns.join(", ")}</p>
            `;
            
            if (data.cleaning_actions && data.cleaning_actions.length > 0) {
                analysisHTML += '<p><strong>Data Cleaning:</strong></p><ul class="list-disc list-inside text-sm text-gray-300">';
                data.cleaning_actions.forEach(action => {
                    analysisHTML += `<li>${action}</li>`;
                });
                analysisHTML += '</ul>';
            }
            
            analysisHTML += '</div>';
            
            document.getElementById("analysis").innerHTML = analysisHTML;
            document.getElementById("analysisCard").classList.remove("hidden");
            
            let html = "";
            features.forEach(f => html += `<div><label class="text-sm">${f}</label><input type="number" id="quick-${f}" class="w-full bg-slate-700 border rounded px-2 py-1"></div>`);
            document.getElementById("quickInputs").innerHTML = html;
            document.getElementById("quickInputsContainer").classList.remove("hidden");
        }

        async function train() {
            const type = document.getElementById("modelType").value || "regression";
            const name = document.getElementById("modelName").value;
            if (!uploadedFile || !name) { alert("Fill all fields"); return; }
            
            const fd = new FormData();
            fd.append("file", uploadedFile);
            document.getElementById("trainLoading").classList.remove("hidden");
            
            const endpoint = type === "regression" ? "train-regression" : "train-classification";
            const res = await fetch(`http://127.0.0.1:9000/${endpoint}?model_name=${name}`, {
                method: "POST", body: fd, headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await res.json();
            
            if (data.error) {
                alert("Error: " + data.error);
                document.getElementById("trainLoading").classList.add("hidden");
                return;
            }
            
            let html = `<p>‚úì Model: ${data.model_name}</p>`;
            if (data.r2_score !== null && data.r2_score !== undefined) html += `<p>R¬≤ Score: ${data.r2_score.toFixed(4)}</p>`;
            else if (data.accuracy !== null && data.accuracy !== undefined) html += `<p>Accuracy: ${(data.accuracy*100).toFixed(2)}%</p>`;
            document.getElementById("trainResult").innerHTML = html;
            document.getElementById("trainResultCard").classList.remove("hidden");
            document.getElementById("quickPredictBtn").disabled = false;
            document.getElementById("trainLoading").classList.add("hidden");
        }

        async function quickPredict() {
            const data = {}, type = document.getElementById("modelType").value || "regression";
            features.forEach(f => data[f] = Number(document.getElementById("quick-"+f).value));
            const name = document.getElementById("modelName").value;
            
            if (!name) { alert("Train a model first"); return; }
            if (Object.keys(data).length === 0) { alert("No features to predict"); return; }
            
            document.getElementById("quickLoading").classList.remove("hidden");
            const endpoint = type === "regression" ? "predict-regression" : "predict-classification";
            const res = await fetch(`http://127.0.0.1:9000/${endpoint}?model_name=${name}`, {
                method: "POST", headers: { "Content-Type": "application/json", 'Authorization': `Bearer ${token}` }, body: JSON.stringify(data)
            });
            const result = await res.json();
            
            if (result.error) {
                document.getElementById("quickResult").innerHTML = `Error: ${result.error}`;
            } else if (result.prediction !== undefined && result.prediction !== null) {
                document.getElementById("quickResult").innerHTML = `Prediction: <strong>${result.prediction}</strong>`;
            } else if (result.predicted_class) {
                document.getElementById("quickResult").innerHTML = `Class: <strong>${result.predicted_class}</strong>`;
            } else {
                document.getElementById("quickResult").innerHTML = `Unexpected response: ${JSON.stringify(result)}`;
            }
            
            document.getElementById("quickResultCard").classList.remove("hidden");
            document.getElementById("quickLoading").classList.add("hidden");
        }

        async function loadPredictModels() {
            try {
                const type = document.getElementById("predModelType").value;
                const res = await fetch(`http://127.0.0.1:9000/models/${type}`, 
                    { headers: { 'Authorization': `Bearer ${token}` } });
                if (!res.ok) throw new Error('Failed to load models');
                const data = await res.json();
                const select = document.getElementById("predModelList");
                select.innerHTML = "<option>Select model...</option>";
                if (data.available_models && data.available_models.length > 0) {
                    data.available_models.forEach(m => {
                        const opt = document.createElement("option");
                        opt.value = m;
                        opt.text = m;
                        select.appendChild(opt);
                    });
                }
            } catch (error) {
                console.error('Error loading models:', error);
                document.getElementById("predModelList").innerHTML = "<option>Error loading models</option>";
            }
        }

        async function loadPredictFeatures() {
            const type = document.getElementById("predModelType").value;
            const name = document.getElementById("predModelList").value;
            if (!name || name === "Select model...") return;
            
            const res = await fetch(`http://127.0.0.1:9000/model-metadata/${type}/${name}`, 
                { headers: { 'Authorization': `Bearer ${token}` } });
            const meta = await res.json();
            
            if (meta.error) {
                document.getElementById("modelInfo").innerHTML = `<p style="color: red;">Error: ${meta.error}</p>`;
                document.getElementById("modelInfoCard").classList.remove("hidden");
                return;
            }
            
            document.getElementById("modelInfo").innerHTML = `
                <p>Type: ${meta.model_type}</p>
                <p>Target: ${meta.target_column}</p>
                <p>Features: ${meta.features.length}</p>
            `;
            document.getElementById("modelInfoCard").classList.remove("hidden");
            
            let html = "";
            meta.features.forEach(f => {
                const cleanFeature = f.trim();
                html += `<div><label class="text-sm">${cleanFeature}</label><input type="number" id="pred-${cleanFeature}" class="w-full bg-slate-700 border rounded px-2 py-1"></div>`;
            });
            document.getElementById("predInputs").innerHTML = html;
            document.getElementById("predInputsContainer").classList.remove("hidden");
            document.getElementById("predPredictBtn").disabled = false;
            features = meta.features.map(f => f.trim());
        }

        async function makePrediction() {
            const data = {}, type = document.getElementById("predModelType").value;
            features.forEach(f => {
                const cleanFeature = f.trim();
                const val = document.getElementById("pred-"+cleanFeature).value;
                if (val === "") { alert(`Enter value for ${cleanFeature}`); throw new Error("Missing input"); }
                data[cleanFeature] = Number(val);
            });
            
            const name = document.getElementById("predModelList").value;
            document.getElementById("predLoading").classList.remove("hidden");
            
            const endpoint = type === "regression" ? "predict-regression" : "predict-classification";
            const res = await fetch(`http://127.0.0.1:9000/${endpoint}?model_name=${name}`, {
                method: "POST", headers: { "Content-Type": "application/json", 'Authorization': `Bearer ${token}` }, body: JSON.stringify(data)
            });
            const result = await res.json();
            
            if (result.error) {
                document.getElementById("predResult").innerHTML = `Error: ${result.error}`;
            } else if (result.prediction !== undefined && result.prediction !== null) {
                document.getElementById("predResult").innerHTML = `Prediction: <strong>${result.prediction}</strong>`;
            } else if (result.predicted_class) {
                document.getElementById("predResult").innerHTML = `Class: <strong>${result.predicted_class}</strong>`;
            } else {
                document.getElementById("predResult").innerHTML = `Unexpected response: ${JSON.stringify(result)}`;
            }
            
            document.getElementById("predResultCard").classList.remove("hidden");
            document.getElementById("predLoading").classList.add("hidden");
        }

        async function aiAnalyze() {
            const file = document.getElementById("csvFile").files[0];
            if (!file) { alert("Please upload a CSV file"); return; }
            
            const formData = new FormData();
            formData.append("file", file);
            
            document.getElementById("analysisCard").classList.remove("hidden");
            document.getElementById("analysis").innerHTML = '<p class="text-blue-400 animate-pulse"><i class="fas fa-spinner fa-spin mr-2"></i>AI is analyzing your data...</p>';
            
            try {
                const res = await fetch("http://127.0.0.1:9000/ai-analyze", {
                    method: "POST",
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });
                
                const data = await res.json();
                
                if (res.status !== 200 || !data.success) {
                    document.getElementById("analysis").innerHTML = `<p style="color: #f87171;">‚ùå Error: ${data.detail || 'Failed to analyze'}</p>`;
                    return;
                }
                
                let html = `
                    <div class="space-y-4">
                        <div class="bg-slate-800 rounded p-4 border-l-4 border-blue-500">
                            <p class="text-blue-200 font-semibold text-lg">üîç Problem Type</p>
                            <p class="text-cyan-300 text-2xl font-bold">${data.problem_type}</p>
                        </div>
                        
                        <div class="bg-slate-800 rounded p-4 border-l-4 border-green-500">
                            <p class="text-green-200 font-semibold">üìä Data Quality Score</p>
                            <div class="flex items-center gap-2 mt-2">
                                <div class="w-48 bg-slate-700 rounded-full h-2">
                                    <div class="bg-gradient-to-r from-green-500 to-blue-500 h-2 rounded-full" style="width: ${data.data_quality_score}%"></div>
                                </div>
                                <span class="text-cyan-300 font-bold">${data.data_quality_score}%</span>
                            </div>
                        </div>
                        
                        <div class="bg-slate-800 rounded p-4 border-l-4 border-yellow-500">
                            <p class="text-yellow-200 font-semibold">üí° Key Insights</p>
                            <ul class="text-gray-300 text-sm mt-2 list-disc list-inside space-y-1">
                                ${data.key_insights.map(i => `<li>${i}</li>`).join('')}
                            </ul>
                        </div>
                        
                        ${data.warning_flags.length > 0 ? `
                        <div class="bg-red-900/30 rounded p-4 border-l-4 border-red-500">
                            <p class="text-red-200 font-semibold">‚ö†Ô∏è Warnings</p>
                            <ul class="text-red-200 text-sm mt-2 list-disc list-inside space-y-1">
                                ${data.warning_flags.map(w => `<li>${w}</li>`).join('')}
                            </ul>
                        </div>
                        ` : ''}
                        
                        <div class="bg-slate-800 rounded p-4 border-l-4 border-purple-500">
                            <p class="text-purple-200 font-semibold">‚ú® Recommended Features</p>
                            <p class="text-gray-300 text-sm mt-2">${data.recommended_features.join(', ')}</p>
                        </div>
                        
                        <div class="bg-slate-800 rounded p-4 border-l-4 border-indigo-500">
                            <p class="text-indigo-200 font-semibold">üìã Quality Report</p>
                            <p class="text-gray-300 text-sm mt-2 italic">${data.quality_report}</p>
                        </div>
                        
                        <div class="bg-slate-800 rounded p-4 border-l-4 border-blue-500">
                            <p class="text-blue-200 font-semibold">üöÄ Next Steps</p>
                            <ul class="text-gray-300 text-sm mt-2 list-decimal list-inside space-y-1">
                                ${data.next_steps.map(s => `<li>${s}</li>`).join('')}
                            </ul>
                        </div>
                    </div>
                `;
                document.getElementById("analysis").innerHTML = html;
            } catch (error) {
                console.error('AI Analysis error:', error);
                document.getElementById("analysis").innerHTML = `<p style="color: #f87171;">‚ùå Error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>
